graph TB
    subgraph "External Sources"
        ZKB[zKillboard<br/>RedisQ]
        ZKB_API[zKillboard<br/>API]
        ESI[EVE<br/>ESI API]
    end

    subgraph "Edge Layer"
        GATEWAY[API Gateway<br/>Kong/Traefik<br/>Rate Limiting & Auth]
    end

    subgraph "Frontend Layer"
        WEB[React SPA<br/>+ WebSocket]
    end

    subgraph "Message Bus Layer - Event Streaming"
        KAFKA[Redpanda Single-Node<br/>Kafka-compatible<br/>Low memory footprint]
        KAFKA_TOPICS[Topics:<br/>• killmail.ingested<br/>• killmail.enriched<br/>• battle.created<br/>• battle.updated<br/>• entity.updated<br/>• audit.events]
    end

    subgraph "Queue Layer - Job Processing"
        RABBITMQ[RabbitMQ Single-Node<br/>Durable queues]
        RMQ_QUEUES[Queues:<br/>• enrichment.high<br/>• enrichment.normal<br/>• enrichment.low<br/>• enrichment.dlq<br/>• search.index<br/>• notification]
    end

    subgraph "Service Mesh - Core Services"
        direction TB

        subgraph "Ingestion Domain"
            INGEST_SVC[Ingest Service<br/>1-2 replicas]
            INGEST_DB[(Ingestion DB<br/>PostgreSQL<br/>Single Instance)]
        end

        subgraph "Enrichment Domain"
            ENRICH_SVC[Enrichment Workers<br/>2-5 replicas]
            ENRICH_CACHE[(Redis<br/>Single Instance)]
        end

        subgraph "Clustering Domain"
            CLUSTER_SVC[Clusterer Service<br/>1 replica]
            CLUSTER_DB[(Battles DB<br/>PostgreSQL<br/>Single Instance)]
        end

        subgraph "API Domain"
            API_SVC[API Service<br/>2-3 replicas<br/>Unified Gateway]
            API_CACHE[(Redis Cache<br/>Shared Instance)]
        end

        subgraph "Query Domain"
            QUERY_SVC[Query Service<br/>1 replica<br/>Event Consumer]
            QUERY_DB[(Query Database<br/>PostgreSQL<br/>Read-Optimized)]
        end

        subgraph "Search Domain"
            SEARCH_SVC[Search Sync Service<br/>1 replica]
            TYPESENSE[(Typesense<br/>Single Node)]
        end

        subgraph "Analytics Domain"
            ANALYTICS_SVC[Analytics Service<br/>1 replica]
            GA4[Google Analytics 4<br/>Measurement Protocol]
        end

        subgraph "Notification Domain"
            NOTIF_SVC[Notification Service<br/>1 replica]
            NOTIF_CACHE[(Redis<br/>Shared Instance)]
        end
    end

    subgraph "Data Platform"
        CQRS[Event Store<br/>PostgreSQL<br/>Event Sourcing]
        S3[Object Storage<br/>S3/MinIO<br/>Cold Storage]
    end

    subgraph "Observability Stack"
        OTEL[OTEL Collector<br/>Traces & Metrics]
        PROMETHEUS[Prometheus<br/>Federated]
        LOKI[Loki<br/>Distributed]
        JAEGER[Jaeger<br/>Distributed]
        GRAFANA[Grafana<br/>Unified UI]
    end

    %% External to Edge
    ZKB -->|Poll| INGEST_SVC
    WEB -->|HTTPS| GATEWAY
    GATEWAY -->|Route| API_SVC

    %% Ingestion Flow
    INGEST_SVC -->|Publish: killmail.ingested| KAFKA
    INGEST_SVC -->|Store Raw| INGEST_DB
    KAFKA -->|Consume: killmail.ingested| ENRICH_SVC

    %% Enrichment Flow
    ENRICH_SVC -->|Fetch| ZKB_API
    ENRICH_SVC -->|Fetch| ESI
    ENRICH_SVC -->|Cache| ENRICH_CACHE
    ENRICH_SVC -->|Publish: killmail.enriched| KAFKA
    ENRICH_SVC -->|Queue DLQ on failure| RABBITMQ

    %% Clustering Flow
    KAFKA -->|Consume: killmail.enriched| CLUSTER_SVC
    CLUSTER_SVC -->|Write Battles| CLUSTER_DB
    CLUSTER_SVC -->|Publish: battle.created/updated| KAFKA

    %% Search Indexing
    KAFKA -->|Consume: battle.created| SEARCH_SVC
    SEARCH_SVC -->|Index| TYPESENSE

    %% Analytics Pipeline
    KAFKA -->|Consume: all events| ANALYTICS_SVC
    ANALYTICS_SVC -->|Send Events| GA4

    %% Query Database Rebuild (CQRS)
    KAFKA -->|Consume: battle.created/updated| QUERY_SVC
    QUERY_SVC -->|Rebuild Views| QUERY_DB

    %% API Path (Frontend Gateway)
    API_SVC -->|Read| QUERY_DB
    API_SVC -->|Cache Check| API_CACHE
    API_SVC -->|Search| TYPESENSE
    API_SVC -->|Publish Queries| OTEL

    %% Notifications
    KAFKA -->|Consume: battle.created| NOTIF_SVC
    NOTIF_SVC -->|WebSocket Push| WEB
    NOTIF_SVC -->|Cache Connections| NOTIF_CACHE

    %% Event Sourcing
    KAFKA -->|Stream| CQRS
    CQRS -->|Archive| S3

    %% Observability
    INGEST_SVC -.->|Telemetry| OTEL
    ENRICH_SVC -.->|Telemetry| OTEL
    CLUSTER_SVC -.->|Telemetry| OTEL
    API_SVC -.->|Telemetry| OTEL
    SEARCH_SVC -.->|Telemetry| OTEL
    ANALYTICS_SVC -.->|Telemetry| OTEL

    OTEL -->|Metrics| PROMETHEUS
    OTEL -->|Logs| LOKI
    OTEL -->|Traces| JAEGER
    PROMETHEUS -->|Visualize| GRAFANA
    LOKI -->|Visualize| GRAFANA
    JAEGER -->|Visualize| GRAFANA
